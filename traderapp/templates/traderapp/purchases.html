{% extends "base.html" %}
{% load static %}
{% block content %}
<h2>Заявки</h2>
<link rel="stylesheet" href="{% static 'css/table.css' %}">
<!-- Кнопки фильтров -->
<div class="filter-buttons">
    <a href="?filter_type=active" class="{% if filter_type == 'active' %}active-filter{% endif %}">Активные</a>
    <a href="?filter_type=mine" class="{% if filter_type == 'mine' %}active-filter{% endif %}">Мои</a>
    <a href="?filter_type=completed" class="{% if filter_type == 'completed' %}active-filter{% endif %}">Завершенные</a>
</div>

<!-- Таблица заявок со стилями -->
<table>
    <thead>
        <tr>
            <th>ID</th>
            <th>Банк</th>
            <th>Реквизиты</th>
            <th>Сумма (RUB)</th>
            <th>Надбавка (USDT)</th>
            <th>Курс</th>
            <th>Сумма (USDT)</th>
            <th>Дата создания</th>
            <th>Осталось времени</th>
            <th>Действие</th>
        </tr>
    </thead>
    <tbody>
        {% for bid in bids %}
        <tr>
            <td>{{ bid.id }}</td>
            <td>{{ bid.bank }}</td>
            <td>
                {% if bid.status == 'active' %}
                    {{ bid.account_details|slice:":5" }}*****
                {% else %}
                    {{ bid.account_details }}
                {% endif %}
            </td>
            <td>{{ bid.amount_rub }}</td>
            <td>{{ bid.extra_fee_usdt }}</td>
            <td>{{ bid.exchange_rate }}</td>
            <td>{{ bid.calculate_usdt }}</td>
            <td>{{ bid.created_at }}</td>
            <td>
                {% if bid.status == 'pending' %}
                    <!-- Таймер с ID заявки и оставшимся временем -->
                    <div class="remaining-time" 
                        data-time-left="{{ bid.remaining_time.total_seconds }}" 
                        data-bid-id="{{ bid.id }}">
                    </div>
                {% else %}
                    ---
                {% endif %}
            </td>
            <td>
                {% if filter_type == 'active' %}
                    <!-- Кнопка принятия с использованием AJAX -->
                    <button class="accept-button" data-bid-id="{{ bid.id }}">Принять</button>
                {% elif filter_type == 'mine' %}
                    <!-- Выпадающий список действий -->
                    <form class="bid-action-form" data-bid-id="{{ bid.id }}">
                        {% csrf_token %}
                        <select name="action" required>
                            <option value="" disabled selected>Выберите действие</option>
                            <option value="complete">Завершить</option>
                            <option value="cancel">Отменить</option>
                        </select>
                        <button type="submit" class="complete-button">Выполнить</button>
                    </form>                    
                {% endif %}
            </td>            
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    document.querySelectorAll('.bid-action-form').forEach(form => {
    form.addEventListener('submit', function(event) {
        event.preventDefault(); // Предотвращаем стандартное действие формы

        const bidId = this.getAttribute('data-bid-id');
        const action = this.querySelector('select[name="action"]').value;

        fetch(`/trade/accept_bid/${bidId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}', // Передаем CSRF токен
            },
            body: new URLSearchParams({
                'action': action,
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message); // Уведомление об успехе
                window.location.reload(); // Перезагрузка страницы
            } else {
                alert('Ошибка: ' + data.message); // Уведомление об ошибке
            }
        })
        .catch(error => console.error('Ошибка:', error));
    });
    });

    document.querySelectorAll('.accept-button').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault(); // Предотвратить формирование стандартного действия

            const bidId = this.getAttribute('data-bid-id');

            fetch(`/trade/accept_bid/${bidId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}', // Убедитесь, что передаете CSRF токен
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message); // Показываю сообщение об успехе
                    window.location.reload(); // Перезагрузка страницы с заявками
                } else {
                    alert('Ошибка: ' + data.message); // Показ ошибки, если есть
                }
            })
            .catch(error => console.error('Ошибка:', error));
        });
    });
    document.querySelectorAll('.remaining-time').forEach(function (timer) {
        let timeLeft = parseInt(timer.dataset.timeLeft); // Оставшееся время в секундах
        let bidId = timer.getAttribute('data-bid-id');  // ID заявки

        function updateTimer() {
            if (timeLeft > 0) {
                let hours = Math.floor(timeLeft / 3600);
                let minutes = Math.floor((timeLeft % 3600) / 60);
                let seconds = timeLeft % 60;

                // Форматируем таймер
                const formatTime = (num) => (num < 10 ? '0' + num : num);

                timer.textContent = `${formatTime(hours)}:${formatTime(minutes)}:${formatTime(seconds)}`;
                timeLeft--;
            } else {
                timer.textContent = "Время вышло!";
                
                // Отправить запрос на сервер для автоматической отмены
                cancelBid(bidId);
            }
        }

        function cancelBid(bidId) {
            fetch(`/trade/cancel_bid/${bidId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}', // Передаем CSRF токен
                },
                body: JSON.stringify({ action: 'cancel' }) // Указываем действие
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload(); // Перезагружаем страницу
                }
            })
            .catch(error => console.error('Ошибка отмены заявки:', error));
        }

        // Обновляем таймер каждую секунду
        updateTimer();
        setInterval(updateTimer, 1000);
    });
</script>


{% endblock %}
